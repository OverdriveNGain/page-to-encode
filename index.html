<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js" integrity="sha512-3RlxD1bW34eFKPwj9gUXEWtdSMC59QqIqHnD8O/NoTwSJhgxRizdcFVQhUMFyTp5RwLTDL0Lbcqtl8b7bFAzog==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="sketch.js" id="sketch"></script>

    <title>Image Text Extractor</title>
</head>
<body>
    <div id="controlsrow">
        <div id="contents">
            <input type="file" id="file_input" onchange="onfilepick(event)">
            <button onclick="ongeneratecallback()" id="generatebtn">Generate</button>
            <button onclick="newlinecallback()" id="newlinebtn">New Line</button>
            <button class="reset" onclick="onresetcallback('left')" id="resetleftbtn">â—€ Reset Left</button>
            <button class="reset" onclick="onresetcallback('right')" id="resetrightbtn">Reset Right â–¶</button>
            <button class="reset" onclick="onresetcallback('all')" id="resetallbtn">Reset All ðŸ˜±</button>
            <button onclick="copyrightcallback()" id="copybtn">Copy Right ðŸ“‹</button>
            <button onclick="undocallback()" id="undobtn">Undo â†ª</button>
        </div>
    </div>
    
    <div class="sidebyside">
        <div id="imageholder">
            <img src="" alt="" id="imagedisplay" style="display:none">
        </div>
        <textarea contenteditable="true" spellcheck="true" id="texttocopy" style="flex: 1"></textarea> 
    </div>
    
    <script>
        function onfilepick(e){
            var input = event.target;
			var reader = new FileReader();
            document.querySelector("#imagedisplay").style.display = '';
			reader.onload = function(){
				var dataURL = reader.result;
				var output = document.querySelector('#imagedisplay');
                console.log(output)
				output.src = dataURL;
			};
			reader.readAsDataURL(input.files[0]);

            const image = new Image();
            image.onload = function() {
                addImageData(this.width, this.height);
            }
            image.src = URL.createObjectURL(input.files[0]);
        }

        function ongeneratecallback(){
            setButtonInteractable(false);
            var formData = new FormData();
            formData.append('image', $('#file_input')[0].files[0]);
            $.ajax({
                method: 'POST',
                url: 'https://api.api-ninjas.com/v1/imagetotext',
                data: formData,
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false, 
                headers: {
                    'X-Api-Key': '7bSg3o9Uzf5JHxszsfva1A==eE4mAYJjtg7L0Bkx'
                },
                success: function(result) {
                    console.log(result);
                    addJsonResponse(result);
                    setButtonInteractable(true);
                },
                error: function ajaxError(jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText);
                    setButtonInteractable(true);
                }
            });
        }

        function onresetcallback(where){
            if (where === 'left'){
                boxIToIsSelected = {};
                resetVars()
            }
            else if (where === 'right'){
                document.querySelector('#texttocopy').value = "";

                lastInsertFunctionTextlet = 'jeremymattheudamonthegreat'
                lastInsertFunctionTextAdded = ''
                undoStates = []
                lastSelectionIndex = -1
            }
            else if (where === 'all'){
                document.querySelector('#texttocopy').value = "";
                resetVars()
            }
        }

        function newlinecallback() {
            insertAtCursor(document.querySelector('#texttocopy'), '\n');
        }

        function copyrightcallback() {
            var text = document.querySelector('#texttocopy').value;
            navigator.clipboard.writeText(text).then(function() {
                console.log('Async: Copying to clipboard was successful!');
            }, function(err) {
                console.error('Async: Could not copy text: ', err);
            });
        }

        function setButtonInteractable(interactable){
            document.querySelector('#file_input').disabled = !interactable;
            document.querySelector('#generatebtn').disabled = !interactable;
            document.querySelector('#newlinebtn').disabled = !interactable;
            document.querySelector('#resetleftbtn').disabled = !interactable;
            document.querySelector('#resetrightbtn').disabled = !interactable;
            document.querySelector('#resetallbtn').disabled = !interactable;
            document.querySelector('#copybtn').disabled = !interactable;
            document.querySelector('#undobtn').disabled = !interactable;
        }

        function undocallback(){
            undoDequeue();
        }
    </script>
</body>
</html>